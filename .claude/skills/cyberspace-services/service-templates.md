# Cyberspace Service Templates

Complete, copy-paste ready templates for common service types in the cyberspace service registry.

## Table of Contents

1. [Static HTML Site](#static-html-site)
2. [Static Site from Directory](#static-site-from-directory)
3. [Reverse Proxy (Simple)](#reverse-proxy-simple)
4. [Reverse Proxy (Advanced)](#reverse-proxy-advanced)
5. [WebSocket Application](#websocket-application)
6. [Python Web Application](#python-web-application)
7. [Node.js Application](#nodejs-application)
8. [Docker Container Proxy](#docker-container-proxy)
9. [File Browser Service](#file-browser-service)
10. [API Service with CORS](#api-service-with-cors)

---

## Static HTML Site

Serve a simple static HTML page generated at build time.

**File**: `hosts/cyberspace/nginx/services/my-static-site.nix`

```nix
{ config, pkgs, ... }:

let
  # Generate static HTML content
  webRoot = pkgs.runCommand "my-static-site" {} ''
    mkdir -p $out/css $out/js

    # Create index.html
    cat > $out/index.html <<'EOF'
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>My Static Site</title>
      <link rel="stylesheet" href="/my-site/css/style.css">
    </head>
    <body>
      <h1>Welcome to My Site</h1>
      <p>This is a static site generated by NixOS!</p>
      <script src="/my-site/js/script.js"></script>
    </body>
    </html>
    EOF

    # Create CSS
    cat > $out/css/style.css <<'EOF'
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    EOF

    # Create JS
    cat > $out/js/script.js <<'EOF'
    console.log('Static site loaded!');
    EOF
  '';
in
{
  # Register in service registry
  services.cyberspace.registeredServices.my-static-site = {
    name = "My Static Site";
    description = "Example static website";
    path = "/my-site";
    icon = "ðŸŒ";
    enabled = true;
    tags = ["web" "static"];
  };

  # Configure nginx
  services.nginx.virtualHosts."cyberspace" = {
    locations."/my-site" = {
      alias = "${webRoot}";
      index = "index.html";
      extraConfig = ''
        try_files $uri $uri/ /my-site/index.html;

        # Cache static assets
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg)$ {
          expires 30d;
          add_header Cache-Control "public, immutable";
        }
      '';
    };
  };
}
```

---

## Static Site from Directory

Serve static files from a directory in your home folder or repo.

**File**: `hosts/cyberspace/nginx/services/my-docs.nix`

```nix
{ config, pkgs, ... }:

{
  # Register in service registry
  services.cyberspace.registeredServices.my-docs = {
    name = "Documentation";
    description = "Static documentation site";
    path = "/docs";
    icon = "ðŸ“š";
    enabled = true;
    tags = ["docs" "static"];
  };

  # Configure nginx to serve from a directory
  services.nginx.virtualHosts."cyberspace" = {
    locations."/docs" = {
      # Option 1: Serve from home directory
      alias = "/home/pcasaretto/docs/build";

      # Option 2: Serve from a package (if you have a derivation)
      # alias = "${pkgs.myDocsPackage}";

      index = "index.html";
      extraConfig = ''
        try_files $uri $uri/ /docs/index.html;
        autoindex on;  # Enable directory listing if no index.html
        autoindex_exact_size off;
        autoindex_localtime on;
      '';
    };
  };
}
```

---

## Reverse Proxy (Simple)

Proxy requests to a local service running on a specific port.

**File**: `hosts/cyberspace/nginx/services/my-app.nix`

```nix
{ config, ... }:

{
  # Register in service registry
  services.cyberspace.registeredServices.my-app = {
    name = "My Application";
    description = "Web application on port 8080";
    path = "/app";
    icon = "ðŸš€";
    enabled = true;
    port = 8080;
    tags = ["app" "proxy"];
  };

  # Configure nginx reverse proxy
  services.nginx.virtualHosts."cyberspace" = {
    locations."/app/" = {
      proxyPass = "http://127.0.0.1:8080/";
      extraConfig = ''
        # Forward original host and IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
      '';
    };
  };
}
```

---

## Reverse Proxy (Advanced)

Advanced reverse proxy with custom headers, buffering, and error handling.

**File**: `hosts/cyberspace/nginx/services/advanced-app.nix`

```nix
{ config, ... }:

{
  # Register in service registry
  services.cyberspace.registeredServices.advanced-app = {
    name = "Advanced Application";
    description = "Application with advanced proxy configuration";
    path = "/advanced";
    icon = "âš¡";
    enabled = true;
    port = 3000;
    tags = ["app" "proxy" "advanced"];
  };

  # Configure nginx with advanced options
  services.nginx.virtualHosts."cyberspace" = {
    locations."/advanced/" = {
      proxyPass = "http://127.0.0.1:3000/";
      extraConfig = ''
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Custom headers
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Buffering (disable for streaming responses)
        proxy_buffering off;
        proxy_request_buffering off;

        # Timeouts
        proxy_connect_timeout 90s;
        proxy_send_timeout 90s;
        proxy_read_timeout 90s;

        # Keep-alive
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Error handling
        proxy_intercept_errors on;
        error_page 502 503 504 /error.html;
      '';
    };

    # Custom error page
    locations."/error.html" = {
      return = ''200 "Service temporarily unavailable"'';
      extraConfig = ''
        default_type text/html;
      '';
    };
  };
}
```

---

## WebSocket Application

Proxy WebSocket connections (e.g., for real-time apps).

**File**: `hosts/cyberspace/nginx/services/websocket-app.nix`

```nix
{ config, ... }:

{
  # Register in service registry
  services.cyberspace.registeredServices.websocket-app = {
    name = "WebSocket App";
    description = "Real-time application with WebSocket support";
    path = "/ws-app";
    icon = "ðŸ”Œ";
    enabled = true;
    port = 8081;
    tags = ["app" "websocket" "realtime"];
  };

  # Configure nginx with WebSocket support
  services.nginx.virtualHosts."cyberspace" = {
    locations."/ws-app/" = {
      proxyPass = "http://127.0.0.1:8081/";
      extraConfig = ''
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Disable buffering for WebSockets
        proxy_buffering off;

        # Longer timeouts for persistent connections
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
      '';
    };
  };
}
```

---

## Python Web Application

Run a Python web application with systemd and nginx.

**File**: `hosts/cyberspace/nginx/services/python-app.nix`

```nix
{ config, pkgs, ... }:

let
  # Python application package
  pythonApp = pkgs.python3.pkgs.buildPythonApplication {
    pname = "my-python-app";
    version = "0.1.0";

    # Point to your app source
    src = /home/pcasaretto/projects/my-python-app;

    propagatedBuildInputs = with pkgs.python3.pkgs; [
      flask  # or fastapi, django, etc.
      gunicorn
    ];
  };
in
{
  # Create systemd service
  systemd.services.python-app = {
    description = "Python Web Application";
    wantedBy = [ "multi-user.target" ];
    after = [ "network.target" ];

    serviceConfig = {
      Type = "simple";
      ExecStart = "${pythonApp}/bin/gunicorn -w 4 -b 127.0.0.1:8000 app:app";
      WorkingDirectory = "/var/lib/python-app";
      Restart = "always";
      RestartSec = "10s";
      User = "python-app";

      # Security hardening
      NoNewPrivileges = true;
      PrivateTmp = true;
      ProtectSystem = "strict";
      ProtectHome = true;
      ReadWritePaths = [ "/var/lib/python-app" ];
    };

    environment = {
      PYTHONUNBUFFERED = "1";
      LOG_LEVEL = "info";
    };
  };

  # Create user
  users.users.python-app = {
    isSystemUser = true;
    group = "python-app";
    home = "/var/lib/python-app";
    createHome = true;
  };

  users.groups.python-app = {};

  # Register in service registry
  services.cyberspace.registeredServices.python-app = {
    name = "Python App";
    description = "Python web application with Flask/Gunicorn";
    path = "/python-app";
    icon = "ðŸ";
    enabled = true;
    port = 8000;
    tags = ["python" "app" "backend"];
  };

  # Configure nginx
  services.nginx.virtualHosts."cyberspace" = {
    locations."/python-app/" = {
      proxyPass = "http://127.0.0.1:8000/";
      extraConfig = ''
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      '';
    };
  };
}
```

---

## Node.js Application

Run a Node.js application with systemd and nginx.

**File**: `hosts/cyberspace/nginx/services/node-app.nix`

```nix
{ config, pkgs, ... }:

{
  # Create systemd service
  systemd.services.node-app = {
    description = "Node.js Application";
    wantedBy = [ "multi-user.target" ];
    after = [ "network.target" ];

    serviceConfig = {
      Type = "simple";
      ExecStart = "${pkgs.nodejs}/bin/node server.js";
      WorkingDirectory = "/var/lib/node-app";
      Restart = "always";
      RestartSec = "10s";
      User = "node-app";

      # Security
      NoNewPrivileges = true;
      PrivateTmp = true;
      ProtectSystem = "strict";
      ReadWritePaths = [ "/var/lib/node-app" ];
    };

    environment = {
      NODE_ENV = "production";
      PORT = "3000";
    };
  };

  # Create user
  users.users.node-app = {
    isSystemUser = true;
    group = "node-app";
    home = "/var/lib/node-app";
    createHome = true;
  };

  users.groups.node-app = {};

  # Register in service registry
  services.cyberspace.registeredServices.node-app = {
    name = "Node.js App";
    description = "Node.js application";
    path = "/node-app";
    icon = "ðŸ“—";
    enabled = true;
    port = 3000;
    tags = ["nodejs" "app" "backend"];
  };

  # Configure nginx
  services.nginx.virtualHosts."cyberspace" = {
    locations."/node-app/" = {
      proxyPass = "http://127.0.0.1:3000/";
      extraConfig = ''
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
      '';
    };
  };
}
```

---

## Docker Container Proxy

Proxy to a service running in a Docker container.

**File**: `hosts/cyberspace/nginx/services/docker-app.nix`

```nix
{ config, pkgs, ... }:

{
  # Enable Docker if not already enabled
  virtualisation.docker.enable = true;

  # Create systemd service to run Docker container
  systemd.services.docker-app = {
    description = "Docker Application";
    wantedBy = [ "multi-user.target" ];
    after = [ "docker.service" ];
    requires = [ "docker.service" ];

    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;

      # Start container
      ExecStart = ''
        ${pkgs.docker}/bin/docker run -d \
          --name my-app \
          --restart unless-stopped \
          -p 127.0.0.1:8082:80 \
          nginx:alpine
      '';

      # Stop container
      ExecStop = "${pkgs.docker}/bin/docker stop my-app";
      ExecStopPost = "${pkgs.docker}/bin/docker rm -f my-app";
    };
  };

  # Register in service registry
  services.cyberspace.registeredServices.docker-app = {
    name = "Docker App";
    description = "Application running in Docker container";
    path = "/docker-app";
    icon = "ðŸ³";
    enabled = true;
    port = 8082;
    tags = ["docker" "container" "app"];
  };

  # Configure nginx
  services.nginx.virtualHosts."cyberspace" = {
    locations."/docker-app/" = {
      proxyPass = "http://127.0.0.1:8082/";
      extraConfig = ''
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
      '';
    };
  };
}
```

---

## File Browser Service

Serve a directory with file browsing capabilities.

**File**: `hosts/cyberspace/nginx/services/files.nix`

```nix
{ config, pkgs, ... }:

{
  # Register in service registry
  services.cyberspace.registeredServices.files = {
    name = "File Browser";
    description = "Browse and download files";
    path = "/files";
    icon = "ðŸ“";
    enabled = true;
    tags = ["files" "utility"];
  };

  # Configure nginx with autoindex
  services.nginx.virtualHosts."cyberspace" = {
    locations."/files/" = {
      alias = "/home/pcasaretto/shared/";
      extraConfig = ''
        # Enable directory listing
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        # Custom autoindex styling
        autoindex_format html;

        # Allow downloads
        add_header Content-Disposition 'attachment';

        # Charset
        charset utf-8;
      '';
    };
  };
}
```

---

## API Service with CORS

API service with CORS support for cross-origin requests.

**File**: `hosts/cyberspace/nginx/services/api.nix`

```nix
{ config, ... }:

{
  # Register in service registry
  services.cyberspace.registeredServices.api = {
    name = "REST API";
    description = "Backend API with CORS support";
    path = "/api";
    icon = "ðŸ”Œ";
    enabled = true;
    port = 8083;
    tags = ["api" "backend"];
  };

  # Configure nginx with CORS
  services.nginx.virtualHosts."cyberspace" = {
    locations."/api/" = {
      proxyPass = "http://127.0.0.1:8083/";
      extraConfig = ''
        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

        # Handle preflight requests
        if ($request_method = OPTIONS) {
          add_header Access-Control-Allow-Origin *;
          add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
          add_header Access-Control-Allow-Headers "Authorization, Content-Type";
          add_header Content-Length 0;
          add_header Content-Type text/plain;
          return 204;
        }
      '';
    };
  };
}
```

---

## Template Usage

To use a template:

1. Copy the template code
2. Create a new file: `hosts/cyberspace/nginx/services/<your-service>.nix`
3. Replace placeholders:
   - Service name (e.g., `my-app` â†’ `your-service`)
   - Display name (e.g., `"My Application"` â†’ `"Your Service"`)
   - Description
   - Path (e.g., `/my-app` â†’ `/your-service`)
   - Icon
   - Port number
   - Tags
4. Add import to `hosts/cyberspace/nginx/services/default.nix`
5. Run `sudo nixos-rebuild switch --flake .#cyberspace`

## Quick Checklist

- [ ] Created service file in `hosts/cyberspace/nginx/services/`
- [ ] Configured nginx location or virtualHost
- [ ] Registered in `services.cyberspace.registeredServices`
- [ ] Added import to `services/default.nix`
- [ ] Chose unique path (no conflicts)
- [ ] Selected appropriate port (no conflicts)
- [ ] Added descriptive icon and tags
- [ ] Tested with `sudo nixos-rebuild switch --flake .#cyberspace`
- [ ] Verified service appears in dashboard
- [ ] Tested service accessibility via Tailscale
