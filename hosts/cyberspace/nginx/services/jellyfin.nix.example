{ config, lib, pkgs, ... }:

{
  # Register this service in the dashboard
  # The service will automatically appear on the system-info page!
  services.cyberspace.registeredServices.jellyfin = {
    name = "Jellyfin";
    description = "Media server for streaming movies, TV shows, and music";
    path = "/";  # Or use a subpath like "/jellyfin" if you prefer
    icon = "ðŸŽ¬";
    enabled = true;
    port = 8096;  # Jellyfin default port
    tags = ["media" "streaming" "entertainment"];
  };

  # Configure nginx reverse proxy
  services.nginx.virtualHosts."jellyfin" = {
    listen = [
      { addr = "0.0.0.0"; port = 80; }
    ];

    # If using a subpath instead of root:
    # serverName = "cyberspace";  # Use the same server as main site

    locations."/" = {
      proxyPass = "http://127.0.0.1:8096";  # Jellyfin default port
      proxyWebsockets = true;  # Enable WebSocket support for Jellyfin

      extraConfig = ''
        # Jellyfin-specific headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Protocol $scheme;
        proxy_set_header X-Forwarded-Host $http_host;

        # Disable buffering for streaming
        proxy_buffering off;
      '';
    };
  };

  # Note: You would also need to enable the Jellyfin service itself:
  # services.jellyfin = {
  #   enable = true;
  #   openFirewall = false;  # We're using nginx reverse proxy
  # };
}
